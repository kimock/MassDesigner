from openai import OpenAI
import streamlit as st
import json
import os
from dotenv import load_dotenv
import re


load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

SYSTEM_1 ="""
ë‹¹ì‹ ì€ ê±´ì¶• ë§¤ìŠ¤ ë””ìì¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ â€œë¼ë²¨ë§ ì›ì¹™â€ì— ë”°ë¼, ì‚¬ìš©ìì˜ ìì—°ì–´ ìš”ì²­ì„ í•´ì„í•˜ê³  ê±´ì¶•ì  íŒë‹¨ì„ ê±°ì³ì„œ, **ê¸°ë³¸ êµ¬ì¡° í…œí”Œë¦¿**ì— ë§ì¶˜ ë¼ë²¨ ìš”ì•½ë¬¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”. ì ˆëŒ€ ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì£¼ì„ì„ ë¶™ì´ì§€ ë§ˆì‹­ì‹œì˜¤.

<â€” ë¼ë²¨ë§ ì›ì¹™ â€”>
1. ì¸µë³„ ë†’ì´ëŠ” â€œ1ì¸µâ€, â€œ2ì¸µâ€ ë“±ìœ¼ë¡œ í‘œê¸°.
2. í•œ ì¸µ ë‚´ ìœ„ì¹˜ëŠ” â€œë™ìª½â€, â€œì„œìª½â€, â€œë‚¨ìª½â€, â€œë¶ìª½â€, â€œì¤‘ì•™â€, "ë¶ë™ìª½","ë‚¨ë™ìª½", "ë¶ì„œìª½", "ë‚¨ì„œìª½" ë“±ì˜ ìƒëŒ€ì  ë°©í–¥ ìš©ì–´ë¡œë§Œ í‘œí˜„.
3. ì½”ì–´(restroom, stair, elevator, mechanical)ëŠ” ì±„ê´‘Â·ì§„ì… ë™ì„ ì„ ê³ ë ¤í•´ ë°°ì¹˜í•´ì•¼í•œë‹¤.
4. ì˜¤í”¼ìŠ¤, ë³µë„, ë¡œë¹„, ì½”ì–´ ë“± ê¸°ëŠ¥ì„ ëª…í™•íˆ êµ¬ë¶„.
5. ì—°ê²° ê´€ê³„ëŠ” â€œì—°ê²°ë˜ì–´ ìˆë‹¤â€ë¡œ ì„œìˆ .
6. ëŒì¶œë¶€ë‚˜ í…Œë¼ìŠ¤ëŠ” â€œëŒì¶œë˜ì–´ â€¦ê°€ ëœë‹¤â€ë¡œ ì„œìˆ .
7. ì „ì²´ ìš©ì ë¥ (FAR), í”„ë¡œê·¸ë¨ ë¹„ìœ¨(TPR) ë“± í•„ìš”í•œ ì œì•½ì€ í•œ ë¬¸ì¥ìœ¼ë¡œ ê°„ëµíˆ ì¶”ê°€ ê°€ëŠ¥.
8. ì˜¤í”¼ìŠ¤ëŠ” ì±„ê´‘ê³¼ ì¡°ë§ì´ ê°€ì¥ ì¢‹ì€ ì¥ì†Œì— ë°°ì¹˜í•©ë‹ˆë‹¤, ì½”ì–´ëŠ” ì±„ê´‘ì´ ë³„ë¡œ ì¢‹ì§€ ì•ŠëŠ” ìœ„ì¹˜ì— ë°°ì¹˜í•©ë‹ˆë‹¤.
9. ë¡œë¹„ì™€ ë³µë„ëŠ” ë³„ë„ë¡œ ë¶„ë¦¬í•´ì„œ ìƒê°í•˜ì„¸ìš”.

<â€” ê¸°ë³¸ êµ¬ì¡° í…œí”Œë¦¿ â€”ï¼
[ì¸µìˆ˜] ê·œëª¨ì˜ (í˜•ìš©ì‚¬) ì˜¤í”¼ìŠ¤ ë§¤ìŠ¤ë¥¼ ì„¤ê³„í•´ì¤˜.
[ìœ„ì¹˜]ì— [íƒ€ì…]ê³¼ [íƒ€ì…]ì´ ìˆìœ¼ë©°,
[ìœ„ì¹˜]ì— [íƒ€ì…]ì´ ë°°ì¹˜ë˜ì–´ì•¼ í•œë‹¤.
[ì½”ì–´]ëŠ” [ìœ„ì¹˜]ì— ìˆë‹¤.
[ì¸µìˆ˜(ìµœê³  ì¸µìˆ˜ ì œì™¸)]ì˜ [ì˜¤í”¼ìŠ¤ or ë¡œë¹„]ì€ [ìœ„ì¹˜]ë¡œ ëŒì¶œë˜ì–´ì„œ [í…Œë¼ìŠ¤]ê°€ ëœë‹¤.
[1ì¸µ]ì˜ [ìœ„ì¹˜]ëŠ” [í•„ë¡œí‹°] í˜•íƒœì´ë‹¤.

â€” ì¶œë ¥ ê·œì¹™ â€”
â€¢ ì˜¤ì§ ìœ„ í…œí”Œë¦¿ í˜•ì‹ì˜ ë¼ë²¨ ìš”ì•½ë¬¸ë§Œ ì¶œë ¥.
â€¢ ë¬¸ì¥ ìˆœì„œÂ·í˜•ì‹ì€ í…œí”Œë¦¿ì„ ë”°ë¥´ë˜, ì‚¬ìš©ì ìš”ì²­ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ ì„œìˆ .
â€¢ ì¶”ê°€ ì„¤ëª…Â·ì£¼ì„ ì ˆëŒ€ ê¸ˆì§€.

<ì˜ˆì‹œ>
-6ì¸µ ê·œëª¨ì˜ ë§¤ìŠ¤ë¥¼ ì„¤ê³„í•´ì¤˜, ë™ìª½ì— ë³µë„ê°€ ìˆë‹¤. ë³µë„ì˜ ë¶ìª½ê³¼ ë‚¨ìª½ ë¶€ë¶„ì—ëŠ” ì—˜ë¦¬ë² ì´í„°ì™€ í™”ì¥ì‹¤ì´ ìˆìœ¼ë©°, ê°ê° ë¶ìª½ê³¼ ë‚¨ìª½ì˜ ë³µë„ì™€ ì—°ê²°ë˜ì–´ ìˆë‹¤. ë³µë„ì˜ ë¶ì„œìª½ì—ëŠ” ê³„ë‹¨ì‹¤ì´ ìˆë‹¤. ë§¤ìŠ¤ì˜ ë‚¨ìª½ê³¼ ë‚¨ì„œìª½ì€ ì˜¤í”¼ìŠ¤ê°€ ìˆìœ¼ë©°, ë‚¨ìª½ì˜ ì˜¤í”¼ìŠ¤ëŠ” ë™ìª½ì˜ ë³µë„ì™€ ì—°ê²°ë˜ì–´ ìˆë‹¤. 6ì¸µì˜ ë‚¨ìª½ ì˜¤í”¼ìŠ¤ëŠ” ë¶ìª½ì˜ ê³„ë‹¨ì‹¤ê³¼ë„ ì—°ê²°ë˜ì–´ ìˆë‹¤. 1ì¸µì˜ ë¡œë¹„ëŠ” ë‚¨ìª½ì— ìˆë‹¤.
-11ì¸µ ê·œëª¨ì˜ ë§¤ìŠ¤ë¥¼ ì„¤ê³„í•´ì¤˜, ì„œìª½ì— ì½”ì–´ê°€ ìˆë‹¤. ë¶ì„œìª½ì— ì—˜ë¦¬ë² ì´í„°ê°€ ìˆê³ , ë‚¨ì„œìª½ì— ê¸°ê³„ì‹¤ê³¼ í™”ì¥ì‹¤ì´ ìˆìœ¼ë©°, í™€ì€ ì„œìª½ì—ì„œ ê¸°ëŠ¥ì‹¤ì„ ì—°ê²°í•œë‹¤. ê³„ë‹¨ì‹¤ì€ ì¤‘ì•™ì— ìˆìœ¼ë©° í™€ê³¼ ì—°ê²°ë˜ì–´ìˆë‹¤. ì˜¤í”¼ìŠ¤ëŠ” ë™ìª½ì— ìœ„ì¹˜í•´ìˆë‹¤. 1ì¸µ ë¡œë¹„ëŠ” ë™ìª½ìœ¼ë¡œ ëŒì¶œë˜ì–´ ìˆìœ¼ë©°, 1ì¸µ ì˜¤í”¼ìŠ¤ëŠ” ë™ë‚¨ìª½ìœ¼ë¡œ ëŒì¶œë˜ì–´ í…Œë¼ìŠ¤ê°€ ëœë‹¤.
-7ì¸µ ê·œëª¨ì˜ ë§¤ìŠ¤ë¥¼ ì„¤ê³„í•´ì¤˜, ë¶ì„œìª½ê³¼ ë‚¨ì„œìª½ì— ì—˜ë¦¬ë² ì´í„°ì™€ ê³„ë‹¨ì´ ìˆìœ¼ë©°, ê¸°ê³„ì‹¤ì´ ë¶ìª½ê³¼ ë¶ì„œìª½ì— ìˆë‹¤. ë³µë„ëŠ” ì¤‘ì•™ì—ì„œ ì‚´ì§ ì„œìª½ì— ìˆìœ¼ë©°, ë³µë„ì˜ ì„œìª½ì—ëŠ” í™”ì¥ì‹¤ì´ ìˆë‹¤. ì˜¤í”¼ìŠ¤ëŠ” ë™ìª½ì— ìˆìœ¼ë©°, 2ì¸µë¶€í„°4ì¸µê¹Œì§€ ì˜¤í”¼ìŠ¤ëŠ” ë™ìª½ìœ¼ë¡œ ëŒì¶œë˜ì–´ í…Œë¼ìŠ¤ê°€ ëœë‹¤.


"""

SYSTEM = """
ë‹¹ì‹ ì€ ê±´ì¶• ë§¤ìŠ¤ ë””ìì¸ì„ ìœ„í•œ local_graph ìƒì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
ì‚¬ìš©ìì˜ ìì—°ì–´ ìš”ì²­ì„ í•´ì„í•´, ë°˜ë“œì‹œ ì•„ë˜ ìŠ¤í‚¤ë§ˆì— ë§ì¶˜ **ìœ íš¨í•œ JSON**ë§Œì„ ì¶œë ¥í•˜ì„¸ìš”. ì ˆëŒ€ ì¼ë°˜ í…ìŠ¤íŠ¸ë‚˜ ì¶”ê°€ ì„¤ëª…ì„ ë¶™ì´ì§€ ë§ˆì‹­ì‹œì˜¤.

<â€” Local_graph ìŠ¤í‚¤ë§ˆ â€”>
{
  "node": [
    {
      "floor": int,              // 0â€¦(ì¸µìˆ˜-1)
      "type": int,               // 0:lobby/1:restroom/2:stair/3:elevator/4:office/5:mechanical
      "type_id": int,            // typeë³„ ê³ ìœ  ID
      "center": [z:number,y:number,x:number], // [ë†’ì´, y, x]
      "region_far": float,       // í•´ë‹¹ ë…¸ë“œê°€ ì°¨ì§€í•˜ëŠ” ë©´ì ì˜ ë¹„ìœ¨ (í•´ë‹¹ ê³µê°„ ë©´ì )Ã·(ì „ì²´ ê¸°ì¤€ ë©´ì )
      "neighbors":[[floor,type,type_id], â€¦]
    },
    â€¦
  ]
}

â€» `edge`ëŠ” í•­ìƒ **ì–‘ë°©í–¥**ì„ í‘œí˜„í•˜ì„¸ìš”.
â€» `center` ì¢Œí‘œëŠ” **ë™=+x, ì„œ=â€“x, ë¶=+y, ë‚¨=â€“y ë‚¨ë™=+x-y, ë¶ë™=+x+y ....** ë°©í–¥ ê´€ê³„ë¥¼ ìˆ˜ì¹˜ë¡œ ë°˜ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
â€» ì½”ì–´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ì‹¤ë“¤ì˜ ê·¸ë£¹ì„ ì˜ë¯¸í•©ë‹ˆë‹¤ [1:restroom,2:stair,3:elevator,5:mechanical]
â€» 1ì¸µì—ëŠ” ìµœì†Œ 2ê°œì˜ ë¡œë¹„ ë…¸ë“œë¥¼ ë°°ì¹˜í•˜ì„¸ìš”

<â€” ìƒì„± ê·œì¹™ â€”>
1. **JSON í˜•ì‹ ì—„ìˆ˜**  
   â€¢ ì¶œë ¥ì€ ì˜¤ì§ í•˜ë‚˜ì˜ JSON ê°ì²´ì—¬ì•¼ í•˜ë©°, ì¶”ê°€ í…ìŠ¤íŠ¸ë‚˜ ì£¼ì„ì„ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  
2. **ë…¸ë“œ ì •í•©ì„±**  
   â€¢ ëª¨ë“  ë…¸ë“œì— `floor, region_far, type, type_id, center, neighbors`ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•©ë‹ˆë‹¤.  
   â€¢ `type_id`ëŠ” ê°™ì€ `type` ë‚´ì—ì„œ 0,1,2â€¦ ìˆœìœ¼ë¡œ ë¶€ì—¬í•©ë‹ˆë‹¤.  
3. **ì—£ì§€ ì •í•©ì„±**  
   â€¢ ëª¨ë“  ì—°ê²°(edge)ì€ ë‘ ë°©í–¥ì„ ëª¨ë‘ ë‚˜ì—´í•˜ì„¸ìš”.  
   â€¢ ì‚¬ìš©ìê°€ â€˜Aì™€ Bê°€ ì—°ê²°â€™ì´ë¼ ë§í•˜ë©´, Aâ†’B, Bâ†’A ë‘ ê°œì˜ ì—£ì§€ë¥¼ ê°ê°ì˜ neighborsë…¸ë“œì— ë°˜ì˜í•´ì•¼í•©ë‹ˆë‹¤.  
4. **ì¢Œí‘œ ë…¼ë¦¬**  
   â€¢ â€œì„œìª½ì— í™€ì´ ìˆë‹¤â€ â†’ x ê°’ì€ ìŒìˆ˜ ì—¬ìœ  ë²”ìœ„(ì˜ˆ: â€“1.0)  
   â€¢ â€œë¶ë™ìª½ ì˜¤í”¼ìŠ¤â€ â†’ x>0, y>0 ê°’ì„ ë¶€ì—¬  
   â€¢ ë™ì¼ì¸µ ë‚´ ìƒëŒ€ì  ìœ„ì¹˜ë§Œ ì •í™•í•˜ë©´, ì ˆëŒ€ê°’ì€ ë°˜ë“œì‹œ âˆš2 ê°™ì€ ë³µì¡í•œ ìˆ˜ê°€ ì•„ë‹ˆì–´ë„ ë©ë‹ˆë‹¤(1.0, 1.5 ë“± ê°„ë‹¨í•œ ì‹¤ìˆ˜ í—ˆìš©).  
   â€¢ ë³µë„ëŠ” í•œ ì¸µì— 2ê°œì˜ 0:lobby ë…¸ë“œë¥¼ ë°°ì¹˜í•˜ê³ , ë…¸ë“œë¥¼ ì—°ê²°í•˜ë©° í˜•ì„±í•©ë‹ˆë‹¤.
5. **ì¶œë ¥ ìµœì†Œí™”**  
   â€¢ ê¼­ í•„ìš”í•œ í‚¤ ì™¸ì—ëŠ” ì œê±°í•˜ì„¸ìš”.  
   â€¢ ê³µë°±Â·ì¤„ë°”ê¿ˆì€ JSON í¬ë§·ì— ë§ê²Œë§Œ ìœ ì§€(ê°€ë…ì„±ì„ ìœ„í•´ ë“¤ì—¬ì“°ê¸° ë¶ˆí•„ìš”).
6. **Office Variation**  
   â€¢ â€œëŒì¶œâ€ ìš”ì²­ì´ ìˆëŠ” ì¸µì˜ ì˜¤í”¼ìŠ¤ ë…¸ë“œëŠ”, **ê·¸ ë°©í–¥**ìœ¼ë¡œ x,y ì¢Œí‘œë¥¼ ì¡°ì •í•˜ì„¸ìš”(ì˜ˆ: ë™ìª½ìœ¼ë¡œ ëŒì¶œ -> í•´ë‹¹ ë…¸ë“œì˜ centerì˜ x,yê°’ +a í•˜ê¸°).  
   â€¢ ì¢Œí‘œì— **ì‘ì€ ì„ì˜ ì˜¤í”„ì…‹**(Â±3.0) ì„ ì¶”ê°€í•´, ì™„ì „ ë™ì¼í•œ ì¶• ì •ë ¬ì„ ë°©ì§€í•©ë‹ˆë‹¤.  
"""

def get_jonning(user_request: str):
    response = client.chat.completions.create(
        model="gpt-4o-mini-2024-07-18",
        messages=[
            {"role": "system", "content": SYSTEM_1},
            {"role": "user", "content": user_request}
        ],
        temperature=0,
        max_tokens=5000,
        n=1
    )
    return response.choices[0].message.content.strip()

def make_local_graph(user_request: str):
    response = client.chat.completions.create(
        model="ft:gpt-4o-mini-2024-07-18:gyu:local-maker:BRdQiSHT:ckpt-step-131",
        messages=[
            {"role": "system", "content": SYSTEM},
            {"role": "user", "content": user_request}
        ],
        temperature=0.01,
        max_tokens=16384,
        n=1
    )
    return response.choices[0].message.content.strip()

def extract_json(text: str):
    match = re.search(r'\{[\s\S]*\}', text)
    if match:
        return match.group(0)
    raise ValueError("JSON ë³¸ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

def save_output_to_json(parsed, output_path):
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(parsed, f, indent=2, ensure_ascii=False)
    print(f"ì €ì¥ ì™„ë£Œ: {output_path}")

# ---------------- Streamlit ----------------

with st.spinner("í”„ë¡œê·¸ë¨ ì¡°ë‹ì„ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤...â³"):
    user_prompt = st.session_state.prompt
    width = st.session_state["site_width"]
    depth = st.session_state["site_depth"]
    area = st.session_state["site_area"]
    far = st.session_state["floor_area_ratio"]
    coverage = st.session_state["building_coverage"]
    height_min, height_max = st.session_state["height_limit"]

    # ì¸µìˆ˜ ìë™ ê³„ì‚° ë° ì§€ì‹œë¬¸ ì •ì œ
    floors = int(far // coverage)
    full_prompt = f"{user_prompt}\n{floors}ì¸µ ì˜¤í”¼ìŠ¤ ë§¤ìŠ¤ë¥¼ ì„¤ê³„í•´ì¤˜."

    # 1ë‹¨ê³„: í”„ë¡œê·¸ë¨ ì¡°ë‹ í…ìŠ¤íŠ¸
    first_output = get_jonning(full_prompt)
    print("ğŸ§¾ ì¡°ë‹ ê²°ê³¼:\n", first_output)

    # 2ë‹¨ê³„: ì¡°ë‹ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ local graph ìƒì„±
    raw_response = make_local_graph(first_output)

    # 3ë‹¨ê³„: JSON ì €ì¥
    try:
        json_text = extract_json(raw_response)
        local_graph = json.loads(json_text)

        output_path = "Data/6types-raw_data/local_graph_data/local_g.json"
        save_output_to_json(local_graph, output_path)

        st.session_state.graph_data = local_graph
        st.success("âœ… í”„ë¡œê·¸ë¨ ì¡°ë‹ ì™„ë£Œ!")
    except Exception as e:
        st.error(f"âŒ JSON íŒŒì‹± ì‹¤íŒ¨: {e}")
        st.text_area("ğŸ“„ ì›ë³¸ ì‘ë‹µ ë‚´ìš©", raw_response, height=300)